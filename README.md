# 财报数据收集与分析系统

## 概述

`main.py` 是一个基于 LangChain 的多 Agent 系统，用于自动收集和分析上市公司财报数据。系统采用三层架构：路由 Agent 负责意图识别，数据收集 Agent 负责数据爬取，数据分析 Agent 负责数据解读。

## 核心功能

### 1. 数据收集
- 支持通过公司名称或股票代码收集财报数据
- 自动识别公司名称并转换为股票代码（如：安井食品 → 603345）
- 支持指定年份范围的数据收集
- 数据收集前会显示参数确认，用户确认后执行

### 2. 数据分析
- 基于已收集的财报数据进行分析
- 支持自然语言提问（如："2024年营收是多少？"）
- 自动读取最新收集的数据文件进行分析

## 系统架构

### 路由 Agent
- **职责**：根据用户意图判断应该调用哪个子 Agent
- **输出**：JSON 格式的路由决策 `{"tool": "route_to_data_collection/route_to_data_analysis", "user_input": "..."}`
- **特点**：所有用户输入都经过路由 Agent 处理

### 数据收集 Agent
- **职责**：提取用户请求中的股票代码、年份等参数，执行数据收集
- **工具**：
  - `collect_financial_data_pipeline`：提取并确认参数
  - `execute_financial_data_collection`：执行实际数据收集
- **特点**：支持公司名称自动转股票代码

### 数据分析 Agent
- **职责**：分析已收集的财报数据，回答用户问题
- **工具**：
  - `report_analysis_tool`：读取数据文件并分析
  - `终止`：终止分析流程
- **特点**：自动读取最新收集的数据文件

## 技术特点

- **共享 Memory**：所有 Agent 共享同一个对话历史，确保上下文传递
- **自动路由**：根据用户意图自动选择对应的 Agent
- **参数确认**：数据收集前会显示参数供用户确认
- **动态路径**：数据分析 Agent 自动使用最新收集的数据文件路径

## 使用方法

### 环境配置
1. 安装依赖：`pip install -r requirements.txt`
2. 配置环境变量：在 `.env` 文件中设置 `OPENAI_API_KEY`

### 运行系统
```bash
python main.py
```

### 使用示例

**数据收集：**
```
你: 我想要安井食品2024年的财报
AI: 我已成功提取您请求的参数，请确认：
{
  "tool": "collect_financial_data_pipeline",
  "parameters": {
    "stock_code": "603345",
    "start_date": 2024-01-01,
    "end_date": 2024-12-31
  }
}
请回复 **'确认'** 或 **'否认'**。

你: 确认
AI: 已按以下信息爬取财报数据...
```

**数据分析：**
```
你: 2024年营收是多少？
AI: [基于已收集的数据进行分析并回答]
```

## 注意事项

- 数据收集需要一定时间，请耐心等待
- 数据分析 Agent 会自动使用最新收集的数据文件
- 输入 '退出' 或 'exit' 可结束对话
